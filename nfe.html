<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Emissor NFe & NFSe – Front‑end</title>
  <style>
    :root{
      --bg:#0b0f1a;--panel:#121829;--muted:#6b7280;--text:#e5e7eb;--brand:#7c3aed;--ok:#16a34a;--warn:#ea580c;--bad:#ef4444;--line:#263049;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0f1a,#0f1424);font:14px/1.5 system-ui,Segoe UI,Roboto,Ubuntu;color:var(--text);}
    .container{max-width:1200px;margin:24px auto;padding:0 16px}
    .app{background:var(--panel);border:1px solid var(--line);border-radius:16px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    header{display:flex;gap:14px;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--line);}
    header .title{display:flex;gap:12px;align-items:center}
    .badge{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid var(--line);color:#cbd5e1}
    .row{display:flex;gap:16px}
    .col{flex:1}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--line);background:#1b2340;color:var(--text);padding:9px 14px;border-radius:10px;cursor:pointer;transition:.2s;}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(124,58,237,.25)}
    .btn.brand{background:linear-gradient(90deg,#7c3aed,#2563eb);border-color:#3a2f6b}
    .btn.ok{background:linear-gradient(90deg,#059669,#16a34a);border-color:#0b7a4e}
    .btn.warn{background:linear-gradient(90deg,#f59e0b,#ea580c);border-color:#b45309}
    .btn.bad{background:linear-gradient(90deg,#ef4444,#b91c1c);border-color:#7f1d1d}
    .btn.ghost{background:transparent}
    .tabs{display:flex;border-bottom:1px solid var(--line);background:#10172a}
    .tab{padding:12px 16px;cursor:pointer;border-bottom:2px solid transparent;color:#cbd5e1}
    .tab.active{border-color:var(--brand);color:#fff;background:#0f162a}
    .page{display:none;padding:16px}
    .page.active{display:block}
    .card{background:#0f162a;border:1px solid var(--line);border-radius:12px;padding:14px;margin-bottom:16px}
    .card h3{margin:0 0 10px;font-size:15px;letter-spacing:.2px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
    label{font-size:12px;color:#9aa3b2}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;background:#0b1226;border:1px solid #223057;color:#dbe3f3;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.25)}
    .col-3{grid-column:span 3}
    .col-4{grid-column:span 4}
    .col-6{grid-column:span 6}
    .col-8{grid-column:span 8}
    .col-9{grid-column:span 9}
    .col-12{grid-column:span 12}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line);}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    th{background:#0d1426;color:#a7b0c1}
    tfoot td{font-weight:600}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .status.ok{color:#22c55e;border-color:#115e38}
    .status.bad{color:#ef4444;border-color:#7f1d1d}
    .status.warn{color:#f59e0b;border-color:#b45309}
    .hint{font-size:12px;color:#9aa3b2}
    .footer{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap;margin-top:8px}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;font-size:12px;background:#0b1226;border:1px solid #223057;border-radius:6px;padding:2px 6px;color:#cbd5e1}
    .toast{position:fixed;right:16px;bottom:16px;padding:12px 16px;border-radius:10px;background:#111827;border:1px solid var(--line);box-shadow:0 10px 24px rgba(0,0,0,.35);display:none}
    .toast.show{display:block}
    .sr{position:absolute;left:-9999px}
    .divider{height:1px;background:var(--line);margin:10px 0}
    .help{font-size:12px;color:#9aa3b2;margin-top:6px}
    .link{color:#93c5fd;text-decoration:none}
  </style>
</head>
<body>
  <div class="container">
    <div class="app" id="app">
      <header>
        <div class="title">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 7h16M4 12h16M4 17h16" stroke="#7c3aed" stroke-width="2" stroke-linecap="round"/></svg>
          <div>
            <div style="font-weight:700;letter-spacing:.3px">Emissor NFe & NFSe (Front‑end)</div>
            <div class="muted" style="font-size:12px">Estratégico, pronto para integrar – Certificado A1 (PFX) & assinatura</div>
          </div>
        </div>
        <div class="toolbar">
          <button class="btn ghost" id="btnLoadDemo" title="Preencher com dados de exemplo">Demo</button>
          <button class="btn brand" id="btnSalvarRascunho">Salvar rascunho</button>
          <button class="btn ok" id="btnValidar">Validar</button>
          <button class="btn warn" id="btnGerarXML">Gerar XML</button>
          <button class="btn" id="btnAssinar" title="Assinar digitalmente com A1">Assinar</button>
          <button class="btn bad" id="btnTransmitir" title="Transmitir para SEFAZ / Prefeitura">Transmitir</button>
        </div>
      </header>

      <nav class="tabs" role="tablist" aria-label="Tipo de Documento">
        <div class="tab active" data-tab="tab-cert">Certificado A1</div>
        <div class="tab" data-tab="tab-emissor">Emitente</div>
        <div class="tab" data-tab="tab-nfe">NFe – Produto (55)</div>
        <div class="tab" data-tab="tab-nfse">NFSe – Serviço</div>
        <div class="tab" data-tab="tab-preview">Pré‑visualizar / XML</div>
      </nav>

      <!-- CERTIFICADO -->
      <section class="page active" id="tab-cert">
        <div class="card">
          <h3>Certificado Digital A1 (arquivo .pfx)</h3>
          <div class="grid">
            <div class="col-6">
              <label for="certFile">Arquivo .pfx</label>
              <input type="file" id="certFile" accept=".pfx,.p12" />
              <div class="help">Seu certificado não é enviado a terceiros neste front‑end. Para transmissão real, um backend seguro será necessário.</div>
            </div>
            <div class="col-3">
              <label for="certPass">Senha do PFX</label>
              <input type="password" id="certPass" placeholder="••••••" />
            </div>
            <div class="col-3">
              <label for="certAlias">Apelido (opcional)</label>
              <input type="text" id="certAlias" placeholder="Minha Empresa" />
            </div>
            <div class="col-12">
              <button class="btn" id="btnCarregarCert">Carregar / Validar Certificado</button>
              <span class="pill status warn" id="certStatus">Aguardando carregamento…</span>
              <div class="help">Este front‑end inclui verificação básica do PKCS#12 via Web Crypto <span class="kbd">SubtleCrypto</span> (quando suportado). Para assinatura XML (XAdES) e transmissão, utilize as rotas da sua API.</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Configurações de Transmissão (placeholders de API)</h3>
          <div class="grid">
            <div class="col-4">
              <label for="apiBase">API Base</label>
              <input id="apiBase" placeholder="https://suaapi.com" />
              <div class="hint">Ex.: <span class="kbd">/api/nfe</span> e <span class="kbd">/api/nfse</span></div>
            </div>
            <div class="col-4">
              <label for="ufSefaz">UF SEFAZ</label>
              <select id="ufSefaz">
                <option value="SP">SP</option>
                <option value="RJ">RJ</option>
                <option value="MG">MG</option>
                <option value="PR">PR</option>
                <option value="RS">RS</option>
                <option value="SC">SC</option>
                <option value="BA">BA</option>
                <option value="ES">ES</option>
                <option value="GO">GO</option>
                <option value="MS">MS</option>
                <option value="MT">MT</option>
                <option value="PA">PA</option>
                <option value="PE">PE</option>
                <option value="CE">CE</option>
                <option value="RO">RO</option>
                <option value="RR">RR</option>
                <option value="AM">AM</option>
                <option value="AC">AC</option>
                <option value="AP">AP</option>
                <option value="AL">AL</option>
                <option value="PB">PB</option>
                <option value="PI">PI</option>
                <option value="RN">RN</option>
                <option value="MA">MA</option>
                <option value="SE">SE</option>
                <option value="TO">TO</option>
                <option value="DF">DF</option>
              </select>
            </div>
            <div class="col-4">
              <label for="ambiente">Ambiente</label>
              <select id="ambiente">
                <option value="2">Homologação</option>
                <option value="1">Produção</option>
              </select>
            </div>
          </div>
        </div>
      </section>

      <!-- EMITENTE -->
      <section class="page" id="tab-emissor">
        <div class="card">
          <h3>Dados do Emitente</h3>
          <div class="grid">
            <div class="col-4"><label>CNPJ</label><input id="emit_cnpj" placeholder="00.000.000/0001-00"/></div>
            <div class="col-4"><label>IE</label><input id="emit_ie" placeholder="Isento? deixe vazio"/></div>
            <div class="col-4"><label>CRT</label><select id="emit_crt"><option value="1">1 – Simples Nacional</option><option value="2">2 – Simples – Excesso</option><option value="3">3 – Regime Normal</option></select></div>
            <div class="col-12"><label>Razão Social</label><input id="emit_razao"/></div>
            <div class="col-9"><label>Fantasia</label><input id="emit_fantasia"/></div>
            <div class="col-3"><label>CEP</label><input id="emit_cep" placeholder="00000-000"/></div>
            <div class="col-6"><label>Endereço</label><input id="emit_logradouro"/></div>
            <div class="col-2"><label>Número</label><input id="emit_numero"/></div>
            <div class="col-4"><label>Bairro</label><input id="emit_bairro"/></div>
            <div class="col-6"><label>Município</label><input id="emit_municipio" placeholder="Araçatuba"/></div>
            <div class="col-2"><label>UF</label><input id="emit_uf" placeholder="SP"/></div>
            <div class="col-4"><label>IBGE (cMun)</label><input id="emit_ibge" placeholder="3502804"/></div>
            <div class="col-6"><label>Email</label><input id="emit_email"/></div>
            <div class="col-6"><label>Fone</label><input id="emit_fone" placeholder="(xx) xxxxx-xxxx"/></div>
          </div>
        </div>
      </section>

      <!-- NFE (55) -->
      <section class="page" id="tab-nfe">
        <div class="card">
          <h3>Destinatário</h3>
          <div class="grid">
            <div class="col-4"><label>CPF/CNPJ</label><input id="dest_doc"/></div>
            <div class="col-4"><label>IE</label><input id="dest_ie"/></div>
            <div class="col-4"><label>Nome/Razão</label><input id="dest_nome"/></div>
            <div class="col-3"><label>CEP</label><input id="dest_cep"/></div>
            <div class="col-6"><label>Endereço</label><input id="dest_logradouro"/></div>
            <div class="col-3"><label>Número</label><input id="dest_numero"/></div>
            <div class="col-4"><label>Bairro</label><input id="dest_bairro"/></div>
            <div class="col-4"><label>Município</label><input id="dest_municipio"/></div>
            <div class="col-1"><label>UF</label><input id="dest_uf"/></div>
            <div class="col-3"><label>IBGE (cMun)</label><input id="dest_ibge"/></div>
            <div class="col-6"><label>Email</label><input id="dest_email"/></div>
            <div class="col-6"><label>Fone</label><input id="dest_fone"/></div>
          </div>
        </div>

        <div class="card">
          <h3>Produtos / Itens</h3>
          <div class="grid">
            <div class="col-3"><label>Código</label><input id="item_cod"/></div>
            <div class="col-5"><label>Descrição</label><input id="item_desc"/></div>
            <div class="col-2"><label>NCM</label><input id="item_ncm"/></div>
            <div class="col-2"><label>CFOP</label><input id="item_cfop"/></div>
            <div class="col-3"><label>Quantidade</label><input id="item_qtde" type="number" step="0.0001"/></div>
            <div class="col-3"><label>Unid.</label><input id="item_un" value="UN"/></div>
            <div class="col-3"><label>Vlr Unit.</label><input id="item_vun" type="number" step="0.01"/></div>
            <div class="col-3"><label>% Desconto</label><input id="item_pDesc" type="number" step="0.01" value="0"/></div>
            <div class="col-12">
              <div class="toolbar">
                <button class="btn" id="btnAddItem">Adicionar Item (Enter)</button>
                <span class="hint">Impostos básicos calculados automaticamente (ICMS, PIS/COFINS simplificados).</span>
              </div>
            </div>
          </div>

          <div class="divider"></div>
          <div class="table-wrap">
            <table id="tblItens">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Código</th>
                  <th>Descrição</th>
                  <th class="right">Qtde</th>
                  <th>UN</th>
                  <th class="right">Vlr Unit.</th>
                  <th class="right">Desc</th>
                  <th class="right">Subtotal</th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot>
                <tr>
                  <td colspan="7" class="right">Total Produtos</td>
                  <td class="right" id="totProdutos">0,00</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <div class="card">
          <h3>Totais & Impostos</h3>
          <div class="grid">
            <div class="col-3"><label>Frete</label><input id="vlr_frete" type="number" step="0.01" value="0"/></div>
            <div class="col-3"><label>Seguros</label><input id="vlr_seguro" type="number" step="0.01" value="0"/></div>
            <div class="col-3"><label>Outras Desp.</label><input id="vlr_outras" type="number" step="0.01" value="0"/></div>
            <div class="col-3"><label>Desconto Total</label><input id="vlr_desc_total" type="number" step="0.01" value="0"/></div>
            <div class="col-3"><label>% ICMS</label><input id="pICMS" type="number" step="0.01" value="18"/></div>
            <div class="col-3"><label>% PIS</label><input id="pPIS" type="number" step="0.01" value="1.65"/></div>
            <div class="col-3"><label>% COFINS</label><input id="pCOFINS" type="number" step="0.01" value="7.6"/></div>
            <div class="col-3"><label>Forma Pagto</label>
              <select id="tPag">
                <option value="01">Dinheiro</option>
                <option value="03">Cartão Crédito</option>
                <option value="04">Cartão Débito</option>
                <option value="15">PIX</option>
                <option value="17">Boleto</option>
              </select>
            </div>
            <div class="col-12">
              <div class="footer">
                <div>
                  <span class="pill">ICMS: <span id="resICMS">0,00</span></span>
                  <span class="pill">PIS: <span id="resPIS">0,00</span></span>
                  <span class="pill">COFINS: <span id="resCOFINS">0,00</span></span>
                </div>
                <div>
                  <span class="pill" style="font-weight:700">Total NF: R$ <span id="resTotal">0,00</span></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- NFSE -->
      <section class="page" id="tab-nfse">
        <div class="card">
          <h3>Tomador do Serviço</h3>
          <div class="grid">
            <div class="col-4"><label>CPF/CNPJ</label><input id="tom_doc"/></div>
            <div class="col-8"><label>Nome/Razão</label><input id="tom_nome"/></div>
            <div class="col-3"><label>CEP</label><input id="tom_cep"/></div>
            <div class="col-6"><label>Endereço</label><input id="tom_logradouro"/></div>
            <div class="col-3"><label>Número</label><input id="tom_numero"/></div>
            <div class="col-4"><label>Bairro</label><input id="tom_bairro"/></div>
            <div class="col-4"><label>Município</label><input id="tom_municipio"/></div>
            <div class="col-1"><label>UF</label><input id="tom_uf"/></div>
            <div class="col-3"><label>IBGE (cMun)</label><input id="tom_ibge"/></div>
          </div>
        </div>

        <div class="card">
          <h3>Serviços</h3>
          <div class="grid">
            <div class="col-4"><label>Item Lista Serviço (LC116)</label><input id="srv_item" placeholder="Ex.: 14.01"/></div>
            <div class="col-4"><label>CNAE</label><input id="srv_cnae"/></div>
            <div class="col-4"><label>Natureza Operação</label><select id="srv_nat"><option>1 – Tributação no município</option><option>2 – Tributação fora do município</option><option>3 – Isento</option><option>4 – Imune</option></select></div>
            <div class="col-8"><label>Descrição do Serviço</label><input id="srv_desc"/></div>
            <div class="col-2"><label>Qtd</label><input id="srv_qtde" type="number" step="0.0001" value="1"/></div>
            <div class="col-2"><label>Vlr Unit.</label><input id="srv_vun" type="number" step="0.01"/></div>
            <div class="col-3"><label>% ISS</label><input id="pISS" type="number" step="0.01" value="2"/></div>
            <div class="col-3"><label>Retém ISS?</label><select id="retISS"><option value="0">Não</option><option value="1">Sim</option></select></div>
            <div class="col-3"><label>Cód. Trib. Município</label><input id="srv_cod_mun" placeholder="Ex.: 0107"/></div>
            <div class="col-3"><label>Município Prestação (cMun)</label><input id="srv_mun_prest" placeholder="Araçatuba / 3502804"/></div>
            <div class="col-12">
              <div class="footer">
                <span class="pill">Base: R$ <span id="resBaseISS">0,00</span></span>
                <span class="pill">ISS: R$ <span id="resISS">0,00</span></span>
                <span class="pill" style="font-weight:700">Total NFSe: R$ <span id="resTotalNFSe">0,00</span></span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PREVIEW -->
      <section class="page" id="tab-preview">
        <div class="card">
          <h3>Pré‑visualização</h3>
          <div class="row">
            <div class="col">
              <label>Tipo</label>
              <select id="prev_tipo"><option value="nfe">NFe</option><option value="nfse">NFSe</option></select>
            </div>
            <div class="col" style="text-align:right">
              <div class="toolbar" style="justify-content:flex-end">
                <button class="btn" id="btnBaixarJSON">Baixar JSON</button>
                <button class="btn" id="btnBaixarXML">Baixar XML</button>
                <button class="btn" id="btnCopiarXML">Copiar XML</button>
              </div>
            </div>
          </div>
          <textarea id="preview" rows="18" spellcheck="false" style="width:100%;margin-top:8px"></textarea>
          <div class="help">O XML gerado aqui é um <b>modelo simplificado</b> para fins de integração. Sua API deve aplicar a versão vigente (ex.: NFe 4.0, leiaute específico da NFSe do município) e assinar segundo os padrões (XMLDSig/XAdES).</div>
        </div>
      </section>

      <div class="toast" id="toast" role="status" aria-live="polite"></div>
    </div>
  </div>

  <script>
    // Utilidades básicas
    const $ = s=>document.querySelector(s);
    const $$ = s=>Array.from(document.querySelectorAll(s));
    const money = v=> (Number(v||0)).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2});
    const onlyDigits = s=> (s||'').replace(/\D+/g,'');

    function toast(msg, kind='info'){
      const t = $('#toast');
      t.textContent = msg; t.className = 'toast show';
      setTimeout(()=>t.className='toast', 2600);
    }

    // Tabs
    $$('.tab').forEach(tab=>{
      tab.addEventListener('click',()=>{
        $$('.tab').forEach(t=>t.classList.remove('active'));
        $$('.page').forEach(p=>p.classList.remove('active'));
        tab.classList.add('active');
        const id = tab.dataset.tab; $('#'+id).classList.add('active');
      })
    });

    // Itens NFe
    let itens = [];
    function renderItens(){
      const tbody = $('#tblItens tbody'); tbody.innerHTML='';
      let tot = 0;
      itens.forEach((it,idx)=>{
        const tr = document.createElement('tr');
        const subtotal = (it.qtde*it.vun) * (1 - (it.pDesc/100));
        tot += subtotal;
        tr.innerHTML = `
          <td>${idx+1}</td>
          <td>${it.cod}</td>
          <td>${it.desc}</td>
          <td class="right">${money(it.qtde)}</td>
          <td>${it.un}</td>
          <td class="right">${money(it.vun)}</td>
          <td class="right">${money(subtotal*(it.pDesc/100))}</td>
          <td class="right">${money(subtotal)}</td>
          <td><button class="btn" data-rm="${idx}">Remover</button></td>`;
        tbody.appendChild(tr);
      });
      $('#totProdutos').textContent = money(tot);
      calcTotais();
      $$('#tblItens [data-rm]').forEach(b=>b.onclick=()=>{itens.splice(Number(b.dataset.rm),1);renderItens();});
    }

    function addItem(){
      const it={
        cod: $('#item_cod').value.trim(),
        desc: $('#item_desc').value.trim(),
        ncm: onlyDigits($('#item_ncm').value),
        cfop: onlyDigits($('#item_cfop').value),
        qtde: Number($('#item_qtde').value||0),
        un: $('#item_un').value || 'UN',
        vun: Number($('#item_vun').value||0),
        pDesc: Number($('#item_pDesc').value||0)
      };
      if(!it.desc || !it.cfop || !it.qtde || !it.vun){ toast('Preencha: Descrição, CFOP, Quantidade e Valor.', 'warn'); return; }
      itens.push(it);
      renderItens();
      // focus fluxo
      $('#item_cod').value = $('#item_desc').value = $('#item_ncm').value = '';
      $('#item_cfop').value=''; $('#item_qtde').value=''; $('#item_vun').value=''; $('#item_pDesc').value='0';
      $('#item_cod').focus();
    }

    $('#btnAddItem').addEventListener('click', addItem);
    document.addEventListener('keydown', e=>{ if(e.key==='Enter' && document.activeElement.closest('#tab-nfe')){ e.preventDefault(); addItem(); }});

    // Totais NFe
    function calcTotais(){
      const tProd = itens.reduce((s,it)=> s + (it.qtde*it.vun)*(1-(it.pDesc/100)), 0);
      const frete = Number($('#vlr_frete').value||0), seg = Number($('#vlr_seguro').value||0), out = Number($('#vlr_outras').value||0), dsc = Number($('#vlr_desc_total').value||0);
      const base = Math.max(0, tProd + frete + seg + out - dsc);
      const vICMS = base * (Number($('#pICMS').value||0)/100);
      const vPIS = base * (Number($('#pPIS').value||0)/100);
      const vCOFINS = base * (Number($('#pCOFINS').value||0)/100);
      $('#resICMS').textContent = money(vICMS);
      $('#resPIS').textContent = money(vPIS);
      $('#resCOFINS').textContent = money(vCOFINS);
      $('#resTotal').textContent = money(base + vICMS + vPIS + vCOFINS);
    }
    ['vlr_frete','vlr_seguro','vlr_outras','vlr_desc_total','pICMS','pPIS','pCOFINS'].forEach(id=> $('#'+id).addEventListener('input', calcTotais));

    // NFSe totais
    function calcNFSe(){
      const base = Number($('#srv_qtde').value||0) * Number($('#srv_vun').value||0);
      const iss = base * (Number($('#pISS').value||0)/100);
      $('#resBaseISS').textContent = money(base);
      $('#resISS').textContent = money(iss);
      $('#resTotalNFSe').textContent = money(base + (Number($('#retISS').value)==1?0:iss));
    }
    ['srv_qtde','srv_vun','pISS','retISS'].forEach(id=> $('#'+id).addEventListener('input', calcNFSe));

    // JSON Builders
    function buildEmit(){
      return {
        cnpj: onlyDigits($('#emit_cnpj').value),
        ie: onlyDigits($('#emit_ie').value),
        crt: $('#emit_crt').value,
        razao: $('#emit_razao').value.trim(),
        fantasia: $('#emit_fantasia').value.trim(),
        endereco: {
          cep: onlyDigits($('#emit_cep').value),
          logradouro: $('#emit_logradouro').value.trim(),
          numero: $('#emit_numero').value.trim(),
          bairro: $('#emit_bairro').value.trim(),
          municipio: $('#emit_municipio').value.trim(),
          uf: $('#emit_uf').value.trim(),
          ibge: onlyDigits($('#emit_ibge').value)
        },
        contato: { email: $('#emit_email').value.trim(), fone: $('#emit_fone').value.trim() }
      }
    }

    function buildNFe(){
      const emit = buildEmit();
      const dest = {
        doc: onlyDigits($('#dest_doc').value), ie: onlyDigits($('#dest_ie').value), nome: $('#dest_nome').value.trim(),
        endereco: { cep: onlyDigits($('#dest_cep').value), logradouro: $('#dest_logradouro').value.trim(), numero: $('#dest_numero').value.trim(), bairro: $('#dest_bairro').value.trim(), municipio: $('#dest_municipio').value.trim(), uf: $('#dest_uf').value.trim(), ibge: onlyDigits($('#dest_ibge').value) },
        contato: { email: $('#dest_email').value.trim(), fone: $('#dest_fone').value.trim() }
      };
      const totals = {
        frete: Number($('#vlr_frete').value||0), seguro: Number($('#vlr_seguro').value||0), outras: Number($('#vlr_outras').value||0), desconto: Number($('#vlr_desc_total').value||0),
        pICMS: Number($('#pICMS').value||0), pPIS: Number($('#pPIS').value||0), pCOFINS: Number($('#pCOFINS').value||0), tPag: $('#tPag').value
      };
      return { tipo:'nfe', modelo:55, ambiente: $('#ambiente').value, uf: $('#ufSefaz').value, emit, dest, itens, totals };
    }

    function buildNFSe(){
      const emit = buildEmit();
      const tom = { doc: onlyDigits($('#tom_doc').value), nome: $('#tom_nome').value.trim(), endereco: { cep: onlyDigits($('#tom_cep').value), logradouro: $('#tom_logradouro').value.trim(), numero: $('#tom_numero').value.trim(), bairro: $('#tom_bairro').value.trim(), municipio: $('#tom_municipio').value.trim(), uf: $('#tom_uf').value.trim(), ibge: onlyDigits($('#tom_ibge').value) } };
      const serv = { item: $('#srv_item').value.trim(), cnae: $('#srv_cnae').value.trim(), nat: $('#srv_nat').value, desc: $('#srv_desc').value.trim(), qtde: Number($('#srv_qtde').value||0), vun: Number($('#srv_vun').value||0), pISS: Number($('#pISS').value||0), retISS: Number($('#retISS').value||0), codMun: $('#srv_cod_mun').value.trim(), munPrest: $('#srv_mun_prest').value.trim() };
      return { tipo:'nfse', layout:'ABRASF-like', emit, tom, serv };
    }

    // XML (Super simplificado / mock)
    function xmlFromNFe(o){
      const x = [];
      x.push('<?xml version="1.0" encoding="UTF-8"?>');
      x.push('<NFe versao="4.00">');
      x.push('<infNFe>');
      x.push(`<emit><CNPJ>${o.emit.cnpj}</CNPJ><xNome>${o.emit.razao}</xNome></emit>`);
      x.push(`<dest><xNome>${o.dest.nome}</xNome></dest>`);
      x.push('<det>');
      o.itens.forEach((it,i)=>{
        x.push(`<prod><cProd>${it.cod}</cProd><xProd>${it.desc}</xProd><qCom>${it.qtde.toFixed(4)}</qCom><vUnCom>${it.vun.toFixed(2)}</vUnCom></prod>`);
      })
      x.push('</det>');
      x.push('</infNFe>');
      x.push('</NFe>');
      return x.join('');
    }

    function xmlFromNFSe(o){
      const base = o.serv.qtde * o.serv.vun;
      const iss = base * (o.serv.pISS/100);
      return `<?xml version="1.0" encoding="UTF-8"?>\n<NFSe>\n <Prestador><CNPJ>${o.emit.cnpj}</CNPJ><Razao>${o.emit.razao}</Razao></Prestador>\n <Tomador><Doc>${o.tom.doc}</Doc><Nome>${o.tom.nome}</Nome></Tomador>\n <Servico><Item>${o.serv.item}</Item><Desc>${o.serv.desc}</Desc><Vlr>${base.toFixed(2)}</Vlr><ISS>${iss.toFixed(2)}</ISS></Servico>\n</NFSe>`;
    }

    function updatePreview(){
      const t = $('#prev_tipo').value;
      if(t==='nfe'){
        const json = buildNFe();
        $('#preview').value = xmlFromNFe(json);
      } else {
        const json = buildNFSe();
        $('#preview').value = xmlFromNFSe(json);
      }
    }
    $('#prev_tipo').addEventListener('change', updatePreview);

    // Ações topo
    $('#btnValidar').onclick = ()=>{
      const emit = buildEmit();
      if(!emit.cnpj || !emit.razao){ toast('Emitente: informe CNPJ e Razão Social.', 'bad'); return; }
      if($('.tab.active').dataset.tab==='tab-nfe'){
        if(!itens.length){ toast('NFe: adicione ao menos 1 item.', 'bad'); return; }
      }
      toast('Validação básica concluída. Pronto para gerar XML.');
      updatePreview();
    }

    function download(filename, content){
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([content],{type:'text/plain'}));
      a.download=filename; a.click();
    }

    $('#btnGerarXML').onclick = ()=>{ updatePreview(); toast('XML gerado na aba Pré‑visualizar.'); }
    $('#btnBaixarJSON').onclick = ()=>{
      const tipo=$('#prev_tipo').value; const o= tipo==='nfe'?buildNFe():buildNFSe();
      download(`${tipo}-payload.json`, JSON.stringify(o,null,2));
    }
    $('#btnBaixarXML').onclick = ()=>{ updatePreview(); const tipo=$('#prev_tipo').value; download(`${tipo}.xml`, $('#preview').value); }
    $('#btnCopiarXML').onclick = async()=>{ updatePreview(); await navigator.clipboard.writeText($('#preview').value); toast('XML copiado.'); }

    // Rascunho LocalStorage
    $('#btnSalvarRascunho').onclick = ()=>{
      const data={emit:buildEmit(),nfe:buildNFe(),nfse:buildNFSe(),itens};
      localStorage.setItem('emissor_nfe_nfse', JSON.stringify(data));
      toast('Rascunho salvo no navegador.');
    }

    // Demo quickfill
    $('#btnLoadDemo').onclick = ()=>{
      $('#emit_cnpj').value='49.999.054/0001-00';
      $('#emit_razao').value='JK Chopp LTDA';
      $('#emit_fantasia').value='JK Chopp';
      $('#emit_cep').value='16010-230';
      $('#emit_logradouro').value='Av. Exemplo';
      $('#emit_numero').value='123';
      $('#emit_bairro').value='Centro';
      $('#emit_municipio').value='Araçatuba';
      $('#emit_uf').value='SP';
      $('#emit_ibge').value='3502804';
      $('#dest_doc').value='11.222.333/0001-44';
      $('#dest_nome').value='Cliente Exemplo SA';
      $('#dest_cep').value='01001-000';
      $('#dest_municipio').value='São Paulo';
      $('#dest_uf').value='SP';
      $('#dest_ibge').value='3550308';
      $('#item_cod').value='CERV001';
      $('#item_desc').value='Barril de Chopp 50L';
      $('#item_cfop').value='5102';
      $('#item_qtde').value='2';
      $('#item_un').value='UN';
      $('#item_vun').value='320';
      addItem();
      $('#srv_item').value='17.05';
      $('#srv_desc').value='Serviço de instalação de chopeira';
      $('#srv_qtde').value='1';
      $('#srv_vun').value='150';
      calcNFSe();
      toast('Exemplo preenchido.');
    }

    // Certificado A1 – Placeholder de validação (não assina ainda)
    let certBytes = null; let certMeta = null;
    $('#btnCarregarCert').onclick = async()=>{
      const f = $('#certFile').files?.[0]; const pass = $('#certPass').value;
      if(!f){ toast('Selecione o arquivo .pfx/.p12.','bad'); return; }
      const buf = await f.arrayBuffer(); certBytes = new Uint8Array(buf);
      certMeta = { name: f.name, size: f.size, alias: $('#certAlias').value || '', loadedAt: new Date().toISOString() };
      // Aqui poderíamos tentar abrir via WebCrypto/Pkcs12, porém o suporte é limitado nos browsers.
      // A assinatura XML e extração da cadeia devem ser feitas pela sua API (Node/.NET/Java) com segurança.
      $('#certStatus').textContent = `Carregado: ${f.name} (${Math.round(f.size/1024)}KB)`; $('#certStatus').className = 'pill status ok';
      toast('Certificado carregado em memória (front‑end).');
    }

    // Assinar – envia para API (placeholder)
    $('#btnAssinar').onclick = async()=>{
      const tipo = $('.tab.active').dataset.tab.includes('nfse')?'nfse':'nfe';
      const payload = tipo==='nfe'?buildNFe():buildNFSe();
      const base = ($('#apiBase').value||'').replace(/\/$/,'');
      if(!base){ toast('Informe a URL da sua API base.','bad'); return; }
      if(!certBytes){ toast('Carregue o certificado A1 (.pfx).','bad'); return; }
      try{
        const res = await fetch(`${base}/${tipo}/sign`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ payload, pfx: Array.from(certBytes), pass: $('#certPass').value })});
        if(!res.ok) throw new Error('Falha ao assinar');
        const data = await res.json();
        $('#preview').value = data.xml || $('#preview').value;
        toast('Documento assinado pela API.');
      }catch(err){ toast('Assinatura não disponível: configure sua API.','bad'); }
    }

    // Transmitir – envia para API (placeholder)
    $('#btnTransmitir').onclick = async()=>{
      const aba = $('.tab.active').dataset.tab; const tipo = aba==='tab-nfse'?'nfse':'nfe';
      const payload = tipo==='nfe'?buildNFe():buildNFSe();
      const base = ($('#apiBase').value||'').replace(/\/$/,'');
      if(!base){ toast('Informe a URL da sua API base.','bad'); return; }
      try{
        const res = await fetch(`${base}/${tipo}/authorize`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        if(!res.ok) throw new Error('Falha de transmissão');
        const data = await res.json();
        toast(`Autorizado: ${data?.protocolo||'—'}`);
        $('#preview').value = (data?.xmlAutorizado)||$('#preview').value;
      }catch(err){ toast('Transmissão não disponível: configure sua API de autorização.','bad'); }
    }

    // Auto cálculo inicial
    calcTotais(); calcNFSe();
  </script>
</body>
</html>
